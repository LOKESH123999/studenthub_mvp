{% extends "base.html" %}
{% block content %}
<div class="page-title">
  <h1>Attendance</h1>
  <div class="muted">Mark attendance and keep % above target.</div>
</div>

<section class="card">
  <h2>Mark attendance</h2>
  {% if subjects|length == 0 %}
    <p class="muted">Add subjects first in <a href="/subjects">Subjects</a>.</p>
  {% else %}
  <form class="form grid-4" method="post" action="/attendance/mark">
    <div>
      <label>Subject</label>
      <select name="subject_id" required>
        {% for s in subjects %}
          <option value="{{ s.id }}">{{ s.code }} {{ s.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>Date</label>
      <input name="class_date" type="date" value="{{ today }}" required/>
    </div>
    <div>
      <label>Status</label>
      <select name="status" required>
        <option value="present">Present</option>
        <option value="absent">Absent</option>
      </select>
    </div>
    <div>
      <label>Note (optional)</label>
      <input name="note" placeholder="Lab / extra class / reason"/>
    </div>
    <div class="full">
      <button class="btn" type="submit">Save</button>
    </div>
  </form>
  {% endif %}
</section>

<section class="card">
  <h2>Summary</h2>
  {% if summary|length == 0 %}
    <p class="muted">No data yet.</p>
  {% else %}
  <table class="table">
    <thead><tr><th>Subject</th><th>Present/Total</th><th>%</th><th>Target</th><th>Need attend</th><th>Can miss</th></tr></thead>
    <tbody>
      {% for s in summary %}
      <tr>
        <td>{{ s.subject_code }} {{ s.subject_name }}</td>
        <td>{{ s.present }}/{{ s.total }}</td>
        <td class="mono">
          {{ s.percentage }}%
          {% if s.total > 0 and s.percentage < s.target %}
            <span class="pill pill-warn">below target</span>
          {% endif %}
        </td>
        <td class="mono">{{ s.target }}%</td>
        <td class="mono">{{ s.need_attend }}</td>
        <td class="mono">{{ s.safe_absences }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% endif %}
</section>

<section class="card">
  <h2>Recent marks</h2>
  {% if recent|length == 0 %}
    <p class="muted">No attendance records yet.</p>
  {% else %}
    <table class="table">
      <thead><tr><th>Date</th><th>Subject</th><th>Status</th><th>Note</th><th></th></tr></thead>
      <tbody>
      {% for r in recent %}
        <tr>
          <td class="mono">{{ r.class_date }}</td>
          <td>{{ r.subject_code }} {{ r.subject_name }}</td>
          <td>
            {% if r.status == "present" %}
              <span class="pill pill-ok">Present</span>
            {% else %}
              <span class="pill pill-bad">Absent</span>
            {% endif %}
          </td>
          <td>{{ r.note or "" }}</td>
          <td>
            <form method="post" action="/attendance/delete" onsubmit="return confirm('Delete this record?');">
              <input type="hidden" name="record_id" value="{{ r.id }}"/>
              <button class="btn btn-danger" type="submit">Delete</button>
            </form>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}
</section>
{% endblock %}
